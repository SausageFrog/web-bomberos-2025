<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Radio Live ‚Äì Cuerpo de Bomberos de Temuco</title>
    <meta name="description" content="Reproductor en vivo y diccionario de claves CBT." />
    <meta name="theme-color" content="#ef4444" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <style>
      :root {
        --bg: #0b0b0c;
        --panel: #111214;
        --muted: #a3a3a3;
        --text: #ffffff;
        --primary: #ef4444;
        --primary-700: #b91c1c;
        --ring: rgba(239,68,68,0.35);
        --border: #232428;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(180deg, #0b0b0c 0%, #121315 100%);
        color: var(--text);
      }
      .container { max-width: 960px; margin: 0 auto; padding: 16px; }
      header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 12px; }
      header h1 { font-size: 18px; font-weight: 700; margin: 0; }
      header p { font-size: 12px; color: var(--muted); margin: 0; }
      .pill { background: var(--primary); color: #fff; padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 880px) { .grid { grid-template-columns: 1fr 1fr; } }
      .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.35); }
      .card h2 { font-size: 16px; margin: 0; padding: 12px 14px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap: 8px; }
      .card .content { padding: 12px; }
      .player { width: 100%; aspect-ratio: 3/4; border: 0; background: #000; }
      .btn {
        display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius: 8px; border:1px solid var(--border);
        background:#181a1e; color:#fff; cursor:pointer; text-decoration:none; font-weight:600;
      }
      .btn.primary { background: var(--primary); border-color: var(--primary); }
      .btn:hover { filter: brightness(1.05); }
      .muted { color: var(--muted); }
      .field { display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:8px; padding:8px 10px; background:#0f1012; }
      .field input { flex:1; background:transparent; border:0; outline:0; color:#fff; font-size:14px; }
      /* Ventana contenida y scrolleable para resultados */
      .results {
        display:flex;
        flex-direction:column;
        gap:8px;
        max-height: clamp(340px, 58vh, 560px);
        overflow-y:auto;
        overscroll-behavior:contain;
        -webkit-overflow-scrolling:touch;
        padding-block: 4px;
      }
      /* Salvaguardas contra clipping en contenedores padres */
      .card, .content, .grid, body, html { min-height: 0; }
      .res-row { display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#0f1012; }
      .badge {
        display:inline-flex; align-items:center; justify-content:center;
        min-width:48px; height:24px; padding:0 10px; border-radius:999px;
        background:#15171b; border:1px solid #23262c; font-weight:700; color:#e5e7eb;
        white-space: nowrap; hyphens: none; word-break: keep-all; flex: 0 0 auto;
        font-variant-numeric: tabular-nums;
      }
      .desc { color:#e5e7eb; font-size:14px; flex:1 1 auto; }
      .hl { background: #7f1d1d; color: #fff; padding: 0 2px; border-radius: 3px; }
      .badge.offline { background:#0f3b18; border-color:#14532d; color:#86efac }
      .footer { text-align:center; margin-top: 8px; font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>Central de Alarmas ‚Äì CBT</h1>
          <p>Audio en vivo y diccionario de claves</p>
        </div>
        <span class="pill" id="offlineBadge" title="Disponible sin conexi√≥n (diccionario)">Radio Live</span>
      </header>

      <div class="grid">
        <section class="card" aria-labelledby="player-title">
          <h2 id="player-title">Reproductor
            <span style="display:inline-flex; gap:8px; align-items:center">
              <a id="openWebPlayer" class="btn" href="https://www.broadcastify.com/webPlayer/14178" target="_blank" rel="noopener noreferrer">Abrir player</a>
              <a id="openDirect" class="btn" href="https://www.broadcastify.com/listen/feed/14178" target="_blank" rel="noopener noreferrer">Abrir en pesta√±a</a>
            </span>
          </h2>
          <div class="content">
            <iframe id="playerFrame" class="player" title="Broadcastify Player" allow="autoplay" referrerpolicy="no-referrer" src="https://www.broadcastify.com/webPlayer/14178"></iframe>
            <p class="footer">Si el reproductor no carga en este recuadro, usa ‚ÄúAbrir en pesta√±a‚Äù.</p>
          </div>
        </section>

        <section class="card" aria-labelledby="dict-title">
          <h2 id="dict-title">Diccionario de claves
            <span style="display:inline-flex; gap:8px; align-items:center">
              <button id="speakBtn" class="btn" title="Leer resultado">üîä Leer</button>
              <a id="call132" class="btn" href="tel:132">Llamar 132</a>
              <button id="copyLink" class="btn" title="Copiar enlace">Copiar enlace</button>
            </span>
          </h2>
          <div class="content">
            <div class="field" role="search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21L15.8033 15.8033M18 10.5C18 14.0899 15.0899 17 11.5 17C7.91015 17 5 14.0899 5 10.5C5 6.91015 7.91015 4 11.5 4C15.0899 4 18 6.91015 18 10.5Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <input id="searchInput" type="text" placeholder="Buscar: 10-4, 10 4, 10.4, qap‚Ä¶ (/, Esc, Enter)" autocomplete="off" aria-label="Buscar clave" />
            </div>
            <div id="results" class="results" aria-live="polite"></div>
          </div>
        </section>
      </div>

      <p class="footer">Cuerpo de Bomberos de Temuco ¬∑ Frecuencia 5-3 ¬∑ Uso demostrativo</p>
    </div>

    <script>
      // ‚Äî‚Äî‚Äî Datos ‚Äî‚Äî‚Äî
      const CLAVES_TEMUCO = {
        "0-0": "Silenciar transmisiones hasta nueva orden",
        "5-3": "Frecuencia de trabajo CBT",
        "6-7": "Situaci√≥n controlada",
        "6-8": "Disponible/operativa la m√°quina",
        "6-9": "Retorno a cuartel",
        "10-0": "Llamado estructural",
        "10-1": "Llamado de veh√≠culo",
        "10-2": "Fuego en pastizales/matorrales o basura",
        "10-3": "Rescate de personas atrapadas o encerradas",
        "10-3-0": "Posible paro cardiorrespiratorio",
        "10-3-1": "Presunta desgracia / extremidad o anillo atrapado",
        "10-3-2": "Persona encerrada en vivienda o departamento",
        "10-3-7": "Rescate en ascensor",
        "10-4": "Rescate vehicular",
        "10-4-1": "Rescate vehicular con hasta 3 lesionados",
        "10-4-2": "Rescate vehicular con m√∫ltiples lesionados o >3 veh√≠culos",
        "10-4-6": "Rescate vehicular con cami√≥n 3/4 o hazmat involucrado",
        "10-4-7": "Rescate vehicular con veh√≠culos de Bomberos involucrados",
        "10-5": "Materiales peligrosos",
        "10-6": "Emanaci√≥n de gas",
        "10-7": "Llamado el√©ctrico",
        "10-8": "Llamado no clasificado",
        "10-9": "Llamado a otros servicios (no emergencia)",
        "10-10": "Remoci√≥n de escombros o rebrote",
        "10-11": "Servicio a√©reo",
        "10-12": "Apoyo a otros Cuerpos de Bomberos",
        "10-14": "Accidente de aviaci√≥n en √°rea urbana"
      };

      // Q-codes (c√≥digos internacionales de radio) ‚Äî √∫tiles y no espec√≠ficos por ciudad
      const Q_CODES = {
        "qap": "En escucha / a la espera",
        "qra": "Nombre de la estaci√≥n o del operador",
        "qrg": "Frecuencia exacta",
        "qrh": "Variaci√≥n de frecuencia",
        "qri": "Tono de la se√±al",
        "qrk": "Claridad de la se√±al",
        "qrl": "Frecuencia ocupada",
        "qrm": "Interferencia por otras estaciones",
        "qrn": "Interferencias atmosf√©ricas / ruido",
        "qro": "Aumente potencia",
        "qrp": "Disminuya potencia",
        "qrq": "Transmita m√°s r√°pido",
        "qrs": "Transmita m√°s despacio",
        "qrt": "Cese transmisiones",
        "qru": "¬øTiene algo para m√≠? / No tengo tr√°fico",
        "qrv": "Listo para operar",
        "qrx": "Espere / reintente m√°s tarde",
        "qry": "Orden de transmisi√≥n / turno",
        "qrz": "¬øQui√©n me llama?",
        "qsa": "Intensidad de la se√±al",
        "qsb": "Desvanecimiento de se√±al",
        "qsd": "Defecto en la manipulaci√≥n",
        "qsl": "Acuso recibo / confirmaci√≥n",
        "qsm": "Repita el mensaje",
        "qso": "Comunicaci√≥n entre estaciones",
        "qsp": "Retransmita a ‚Ä¶",
        "qsy": "Cambie de frecuencia",
        "qta": "Anule el mensaje",
        "qtc": "Tr√°fico / cantidad de mensajes",
        "qth": "Ubicaci√≥n / posici√≥n",
        "qtr": "Hora exacta"
      };

      // Unificamos en un solo diccionario consultable
      const ALL_CODES_FALLBACK = { ...CLAVES_TEMUCO, ...Q_CODES };

      const STORAGE_KEYS = { lastKey: 'radio:lastKey' };

      // ‚Äî‚Äî‚Äî Utilidades ‚Äî‚Äî‚Äî
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const escapeHTML = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      function stripAccents(str){ try { return str.normalize('NFD').replace(/\p{Diacritic}/gu,''); } catch { return str; } }
      function normalizeKeyInput(value) { return stripAccents(String(value||'')).trim().toLowerCase().replace(/[\.\s]+/g,'-').replace(/-+/g,'-').replace(/^-|-$|[^a-z0-9-]/g,''); }
      function highlightPrefix(text, prefix){ if(!prefix) return escapeHTML(text); const i=text.toLowerCase().indexOf(prefix.toLowerCase()); if(i<0) return escapeHTML(text); const a=escapeHTML(text.slice(0,i)); const b=escapeHTML(text.slice(i,i+prefix.length)); const c=escapeHTML(text.slice(i+prefix.length)); return `${a}<mark class="hl">${b}</mark>${c}`; }
      function highlightContains(text, query){ if(!query) return escapeHTML(text); const t=text.toLowerCase(), q=query.toLowerCase(); const i=t.indexOf(q); if(i<0) return escapeHTML(text); const a=escapeHTML(text.slice(0,i)); const b=escapeHTML(text.slice(i,i+q.length)); const c=escapeHTML(text.slice(i+q.length)); return `${a}<mark class="hl">${b}</mark>${c}`; }

      // ‚Äî‚Äî‚Äî B√∫squeda ‚Äî‚Äî‚Äî
      const searchInput = $('#searchInput');
      const results = $('#results');
      let ALL_CODES = {};
      let SYNONYMS = {};
      let CODE_LIST = [];

      function rowHTML(code, desc, qPrefix='', qInLabel='') { const c=highlightPrefix(code,qPrefix); const d=qInLabel?highlightContains(desc,qInLabel):escapeHTML(desc); return `<div class=\"res-row\"><span class=\"badge\">${c}</span><span class=\"desc\">${d}</span></div>`; }
      function resolveKey(input){ const n=normalizeKeyInput(input); if(ALL_CODES[n]) return n; const vars=[n,n.replace(/-a-/g,'-'),n.replace(/-de-/g,'-'),n.replace(/-la-/g,'-')]; for(const v of vars){ const alias=SYNONYMS[v]; if(alias){ const n2=normalizeKeyInput(alias); if(ALL_CODES[n2]) return n2; } } return n; }

      function renderResults(qRaw){
        const q0=normalizeKeyInput(qRaw);
        const q=resolveKey(q0);
        const exact=q && ALL_CODES[q];
        const keys=Object.keys(ALL_CODES);
        const prefix=(!exact && q)? keys.filter(k=>k.startsWith(q)).sort():[];
        const labelMatches=(!exact && q)? CODE_LIST.filter(it=>it.labelNorm.includes(q) && !prefix.includes(it.key)).map(it=>it.key):[];
        const suggestions=[...prefix,...labelMatches];
        let html='';
        if(!q){
          // Mostrar TODAS las claves por defecto, ordenadas.
          const keys = Object.keys(ALL_CODES).sort((a,b)=>{
            const isQa = /^[qQ]/.test(a), isQb = /^[qQ]/.test(b);
            if(isQa !== isQb) return isQa - isQb; // Num√©ricas primero, luego Q-codes
            const pa = a.split('-').map(n=>Number(n));
            const pb = b.split('-').map(n=>Number(n));
            if(!Number.isNaN(pa[0]) && !Number.isNaN(pb[0])){
              return (pa[0]-pb[0]) || ((pa[1]||0) - (pb[1]||0)) || ((pa[2]||0) - (pb[2]||0));
            }
            return a.localeCompare(b);
          });
          html += `<div class=\"muted\">Escribe una clave (ej: <span class=\"badge\">10-4</span> o <span class=\"badge\">qap</span>) o recorre la lista completa:</div>`;
          html += keys.map(k=>rowHTML(k,ALL_CODES[k],'')).join('');
        } else if (exact) {
          html+=rowHTML(q,ALL_CODES[q],q,'');
        } else if (suggestions.length) {
          html+=`<div class=\"muted\">Resultados</div>`+suggestions.map(k=>{ const inLabel=(CODE_LIST.find(it=>it.key===k)?.labelNorm.includes(q))?q:''; return rowHTML(k,ALL_CODES[k],q,inLabel); }).join('');
        } else {
          html+=`<div class=\"muted\">Sin resultados para <span class=\"badge\">${escapeHTML(q)}</span></div>`;
        }
        results.innerHTML=html;
      }

      async function loadCodes(){
        try {
          const res=await fetch('/data/radio-codes.temuco.json',{cache:'force-cache'});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data=await res.json();
          const dict={}; const list=[];
          (data.codes||[]).forEach(it=>{ const k=normalizeKeyInput(it.key); const lbl=String(it.label||''); dict[k]=lbl; list.push({key:k,label:lbl,labelNorm:stripAccents(lbl.toLowerCase())}); });
          const syn={}; const s=data.synonyms||{}; Object.keys(s).forEach(k=>{ syn[normalizeKeyInput(k)]=s[k]; });
          ALL_CODES={...dict}; SYNONYMS={...syn}; CODE_LIST=list;
        } catch(e){
          ALL_CODES={...ALL_CODES_FALLBACK};
          SYNONYMS={'en-escucha':'QAP','ubicacion':'QTH','regrese-cuartel':'0-10'};
        }
      }

      function applyShortcuts(){
        document.addEventListener('keydown',(e)=>{
          if(e.key==='/' ){ e.preventDefault(); searchInput.focus(); }
          if(e.key==='Escape'){ searchInput.value=''; renderResults(''); }
          if(e.key==='Enter'){
            const q=normalizeKeyInput(searchInput.value);
            const keys=Object.keys(ALL_CODES).filter(k=>k.startsWith(q)).sort();
            if(keys.length){ searchInput.value=keys[0]; renderResults(keys[0]); }
          }
        });
      }

      function setupTTS(){ const btn=$('#speakBtn'); if(!('speechSynthesis' in window)){ btn.style.display='none'; return;} btn.addEventListener('click',()=>{ const key=resolveKey(searchInput.value); const text=ALL_CODES[key]; if(!text) return; const u=new SpeechSynthesisUtterance(`${key}. ${text}`); u.lang='es-ES'; try{ speechSynthesis.cancel(); }catch{} speechSynthesis.speak(u); }); }
      function setupCopyLink(){ const btn=$('#copyLink'); btn.addEventListener('click', async ()=>{ const key=resolveKey(searchInput.value); const url=new URL(window.location.href); if(key) url.searchParams.set('key',key); else url.searchParams.delete('key'); history.replaceState(null,'',url.toString()); try{ await navigator.clipboard.writeText(url.toString()); btn.textContent='Copiado'; setTimeout(()=>btn.textContent='Copiar enlace',1200);}catch{} }); }
      function syncFromURL(){ const p=new URLSearchParams(location.search); const k=p.get('key'); if(k){ searchInput.value=normalizeKeyInput(k);} }

      async function init(){
        if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('/sw.js'); }catch{} }
        if('wakeLock' in navigator){ try{ await navigator.wakeLock.request('screen'); }catch{} }

        await loadCodes();
        const last=localStorage.getItem(STORAGE_KEYS.lastKey);
        syncFromURL();
        if(!searchInput.value && last) searchInput.value=last;
        renderResults(searchInput.value);
        searchInput.addEventListener('input',()=>{ const n=normalizeKeyInput(searchInput.value); localStorage.setItem(STORAGE_KEYS.lastKey,n); renderResults(n); });
        applyShortcuts();
        setupTTS();
        setupCopyLink();
        navigator.serviceWorker?.ready?.then(()=>{ const b=document.getElementById('offlineBadge'); if(b) b.classList.add('offline'); });
        $('#openWebPlayer').addEventListener('click', ()=> setTimeout(()=>window.focus(),50));
        $('#openDirect').addEventListener('click', ()=> setTimeout(()=>window.focus(),50));
      }

      init();
    </script>
  </body>
  </html>
